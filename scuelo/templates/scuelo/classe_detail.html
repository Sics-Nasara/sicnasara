{% extends "../layout.html" %}
{% load crispy_forms_tags %}

<style>
    .form-control {
        border-radius: 20px; 
        padding-left: 20px; 
        padding-right: 40px; 
    }
    .sortable {
        cursor: pointer;
    }
    .sortable i {
        margin-left: 5px;
    }
    .sort-icon {
        margin-left: 5px;
    }
    .sort-icon.asc::after {
        content: "\25b2"; 
    } 
    .sort-icon.desc::after {
        content: "\25bc"; 
    }
    .important-info {
        display: flex;
        flex-wrap: nowrap; 
        align-items: center;
        overflow-x: auto; 
        padding-left: 10px; 
        padding-right: 10px; 
    }
    .important-info-value {
        margin-left: 10px;
    }
    .table-container {
        max-width: 100%; 
        overflow-x: auto; 
    }
</style>

{% block content %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'school_detail' classe.ecole.pk %}">School Details</a></li>
    <li class="breadcrumb-item active" aria-current="page">Class Details</li>
</ol>
<div class="container">
    <h1>Class Details</h1>
    <p><strong>Class Name:</strong> {{ object.nom }}</p>
    <p><strong>Type:</strong> {{ object.type.nom }}</p>
    
    <h2>Students</h2>
    <div class="table-responsive table-container w-100">
        <table class="table table-striped table-bordered" id="studentTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="nom">Nom</th>
                    <th class="sortable" data-sort="prenom">Pr√©nom</th>
                    <th class="sortable" data-sort="condition_eleve">Condition</th>
                    <th class="sortable" data-sort="sex">Sexe</th>
                    <th class="sortable" data-sort="date_naissance">Date naiss</th>
                    <th class="sortable" data-sort="total_payment">Total pag</th>
                    <th class="sortable" data-sort="cs_py">CS_PY</th>
                    <th class="sortable" data-sort="hand">Hand</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td data-column="id">{{ student.id }}</td>
                    <td data-column="nom">{{ student.nom }}</td>
                    <td data-column="prenom">{{ student.prenom }}</td>
                    <td data-column="condition_eleve">{{ student.get_condition_eleve_display }}</td>
                    <td data-column="sex">{{ student.get_sex_display }}</td>
                    <td data-column="date_naissance">{{ student.date_naissance }}</td>
                    <td data-column="total_payment">
                        {% if student.total_payment is not None %}
                        {{ student.total_payment }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td data-column="cs_py">{{ student.get_cs_py_display }}</td>
                    <td data-column="hand">
                        {% if student.hand %}
                        {{ student.get_hand_display }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'student_detail' pk=student.pk %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-pencil-alt"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'classe_update' object.pk %}" class="btn btn-primary">Edit</a>
        <a href="{% url 'classe_delete' object.pk %}" class="btn btn-danger ml-2">Delete</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('studentTable');
        const headers = table.querySelectorAll('.sortable');
        let sortDirection = {};
        
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
                sortTable(column, direction);
                sortDirection[column] = direction;
                
                headers.forEach(h => {
                    if (h !== header) {
                        h.classList.remove('asc', 'desc');
                        h.querySelector('.sort-icon')?.remove();
                    }
                });
                
                header.classList.toggle('asc', direction === 'asc');
                header.classList.toggle('desc', direction === 'desc');
                
                if (direction === 'asc') {
                    header.innerHTML += '<span class="sort-icon asc">&#9650;</span>';
                } else {
                    header.innerHTML += '<span class="sort-icon desc">&#9660;</span>';
                }
            });
        });
        
        function sortTable(column, direction) {
            const rows = Array.from(table.querySelector('tbody').rows);
            const compare = (a, b) => {
                let cellA = a.querySelector(`td[data-column="${column}"]`)?.innerText.trim();
                let cellB = b.querySelector(`td[data-column="${column}"]`)?.innerText.trim();
                
                if (column === 'sex') {
                    cellA = cellA === 'F' ? 0 : 1;
                    cellB = cellB === 'F' ? 0 : 1;
                } else if (!isNaN(cellA) && !isNaN(cellB)) {
                    cellA = parseFloat(cellA);
                    cellB = parseFloat(cellB);
                }
                
                if (direction === 'asc') {
                    return cellA > cellB ? 1 : -1;
                } else {
                    return cellA < cellB ? 1 : -1;
                }
            };
            rows.sort(compare);
            rows.forEach(row => table.querySelector('tbody').appendChild(row));
        }
        
        sortTable('nom', 'asc');
    });
</script>
{% endblock %}
